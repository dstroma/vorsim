<!DOCTYPE html>
<html>
	<head>
		<title>VOR Simulator</title>
		<style type="text/css">
			body { font-family: Tahoma, Helvetica, Arial; font-size: 14px; }
			input, select, submit, button { font-family: Tahoma; Helvetica, Arial; font-size: 13px; font-weight: bold; }
			input#input-heading { text-align: center; }
			canvas#plan { border: 1px solid #030; background: #ccddbb; }
			canvas.instrumentX { border: 1px solid #000; background: #111; }
			div#form { clear: both; width: 480px; text-align: center; }
		</style>
	</head>

	<body>
		<div id="field" style="float: left">
			<canvas id="plan" width="480" height="480"></canvas>
		</div>
		<div id="indicator" style="float: left;">
			<canvas id="vor1" class="instrument" width="200" height="200"></canvas>
		</div>

		<div id="form">
			Airplane heading:<br>
			<input type="text" name="heading" id="input-heading" value="360" size="3" maxlength="3" onchange="sim.updateAirplaneHeading(this);">
			<button onclick="sim.turnAirplaneBy(-10);">&minus;</button>
			<button onclick="sim.turnAirplaneBy(+10);">&plus;</button>
		</div>

	</body>
</html>

<script type="text/javascript">
/***********************************************/
/* Copyright (C) 2013 by Dondi Michael Stroma. */
/* All rights reserved.                        */
/*                                             */
/***********************************************/

function circle(a){
	// Add or subtract 360 degrees as needed so 0 < a < 360
	var original_a = a;
	if (a < 0)
		a = a + 360;
	else if (a > 359)
		a = a - 360;
	if (a < 0 || a > 359) circle(a);
//	console.log('Original a: ' + original_a + ', new a: ' + a);
	return a;
}


var sim = {

	updateAirplaneHeading: function(elem){
		sim.airplane.heading = elem.value;
		sim.overhead.draw();
	},
	turnAirplaneBy: function(amount){
		sim.airplane.heading = circle(sim.airplane.heading + amount);
		document.getElementById('input-heading').value = sim.airplane.heading;
		sim.overhead.draw();
	},

	overhead: {

		canvas: null,

		getCanvas: function(){
			var canvas  = document.getElementById('plan');
			this.canvas = canvas;
			this.canvas.getMousePos = function(evt){
				var rect = canvas.getBoundingClientRect();
				var mousePos = {
					x: evt.clientX - rect.left,
					y: evt.clientY - rect.top
				};
				return mousePos;
			};
			this.ctx = canvas.getContext('2d');
			return canvas;
		},

		isMouseOnAirplane: function(mx, my){
			var scl = 2;
			var ax  = sim.airplane.location[0];
			var ay  = sim.airplane.location[1];
			if (mx >= ax - 6*scl && mx <= ax + 6*scl && my >= ay - 7*scl && my <= ay + 7*scl)
				return true;
			else
				return false;
		},

		isMouseOnVor: function(mx, my){
			var vx = sim.vor1.location[0];
			var vy = sim.vor1.location[1];
			if (mx >= vx - 4 && mx <= vx + 4 && my >= vy - 3 && my <= vy + 3)
				return true;
			else
				return false;
		},

		canvasSize: [480, 480],

		draw: function(){
			sim.overhead.getCanvas();

			var canvas = document.getElementById('plan');
			var ctx    = canvas.getContext('2d');

/*			ctx.beginPath();
			ctx.fillStyle = '#d5d9cb';
			ctx.rect(0, 0,   480, 480);
			ctx.fill();
*/
			ctx.clearRect(0, 0, 480, 480);
			
			sim.overhead.drawStation(sim.vor1.location[0], sim.vor1.location[1], 2);
			sim.overhead.drawAirplane(sim.airplane.location[0], sim.airplane.location[1], sim.airplane.heading, 2);
		},

		drawStation: function(ox, oy, scale){
			var canvas = document.getElementById('plan');
			var ctx    = canvas.getContext('2d');
			if (!scale) scale = 1;
			
			// Make it by default 12 tall and 8 wide
			var w =  8 * scale;
			var h = 12 * scale;
			x = ox + 2*scale;
			y = oy + 3*scale;
			ctx.beginPath();
			ctx.lineWidth = 2;
			ctx.moveTo(x, y);
			ctx.lineTo(x - scale * 4, y); //left
			ctx.lineTo(x - scale * 6, y - scale * 3); //left up
			ctx.lineTo(x - scale * 4, y - scale * 6); //right up
			ctx.lineTo(x, y - scale * 6); // right
			ctx.lineTo(x + scale * 2, y - scale * 3); // right down
			ctx.lineTo(x, y); // left to origin
			//ctx.fillStyle = '#000033';
			ctx.strokeStyle = '#214561';
			//ctx.fill();
			ctx.stroke();

			ctx.beginPath();
			ctx.moveTo(ox, oy);
			ctx.lineTo(ox + 1, oy);
			ctx.lineTo(ox - 1, oy);
			ctx.stroke();
		},

		drawAirplane: function(ox, oy, heading, scale){
			var canvas = document.getElementById('plan');
			var ctx    = canvas.getContext('2d');
			if (!scale) scale = 1;

			var x = ox;
			var y = oy;

			if (!heading) heading = 0;

			ctx.translate(x, y);
			ctx.rotate(Math.PI*2*(heading/360));
			ctx.translate(-x, -y);

			ctx.beginPath();
			ctx.strokeStyle = '#d956ff';
			ctx.moveTo(x, y - 7*scale);
			ctx.lineTo(x, y + 7*scale);
			ctx.moveTo(x - 6*scale, y - 3*scale);
			ctx.lineTo(x + 6*scale, y - 3*scale);
			ctx.moveTo(x - 3*scale, y + 5*scale);
			ctx.lineTo(x + 3*scale, y + 5*scale);
			ctx.stroke();

			ctx.translate(x, y);
			ctx.rotate(-Math.PI*2*(heading/360));
			ctx.translate(-x, -y);

		},
	},

	airplane: {
		location: [100, 100],
		heading:  360,
	},

	vor1: {
		canvas: null,

		getCanvas: function(){
			var canvas  = document.getElementById('vor1');
			this.canvas = canvas;
			this.canvas.getMousePos = function(evt){
				var rect = canvas.getBoundingClientRect();
				var mousePos = {
					x: evt.clientX - rect.left,
					y: evt.clientY - rect.top
				};
				return mousePos;
			};
			this.ctx = canvas.getContext('2d');
			return canvas;
		},

		canvasSize: [200,200],

		obsSetting: 360,
		location: [0, 0],
		cdiDisplacement: -1,
		to_from: 'from',

		obsLabel: function(){
			this.obsSetting = parseInt(this.obsSetting);
			if (this.obsSetting == 360 || this.obsSetting == 0)
				return 'N';
			else if (this.obsSetting == 90)
				return 'E';
			else if (this.obsSetting == 180)
				return 'S';
			else if (this.obsSetting == 270)
				return 'W';
			else if (this.obsSetting < 10)
				return '00' + this.obsSetting;
			else if (this.obsSetting < 100)
				return '0' + this.obsSetting;
			else
				return '' + this.obsSetting;
		},

		draw: function(){
			var c     = this.getCanvas();
			var ctx   = c.getContext("2d");

			var outerRadius = this.canvasSize[0] * 0.45;
			var scaleRadius = this.canvasSize[0] * 0.33;
			var dotSpacing  = scaleRadius*2 / 12;

			// Draw inner CDI portion
			ctx.beginPath();
			ctx.lineWidth = 0;
			ctx.arc(this.canvasSize[0]/2, this.canvasSize[1]/2, scaleRadius, 0, Math.PI*2, true);
			ctx.fillStyle = 'black';
			ctx.strokeStyle = 'black';
			ctx.fill();
			ctx.stroke();

			// Draw white circle
/*
			ctx.beginPath();
			ctx.lineWidth = 2;
			ctx.arc(this.canvasSize[0]/2, this.canvasSize[1]/2, scaleRadius, 0, Math.PI*2, true);
			ctx.strokeStyle = 'white';
			ctx.stroke();
*/

			// Draw "needle"
			var cdiDisplacement = this.cdiDisplacement;

			if (cdiDisplacement > 5.5) 
				cdiDisplacement = 5.5;
			else if (cdiDisplacement < -5.5)
				cdiDisplacement = -5.5;

			ctx.beginPath();
			ctx.lineWidth = 2;
			var x = this.canvasSize[0]/2 - scaleRadius + dotSpacing*(cdiDisplacement+6);
			var y = 0;
			ctx.moveTo(x, 0);
			ctx.lineTo(x, this.canvasSize[0]);
			ctx.strokeStyle = '#FFF';
			ctx.stroke();

			// Draw "dots"
			for (var i = 1; i <= 11; i++) {
				if (i == 6) {
					ctx.beginPath();
					ctx.lineWidth = 2;
					ctx.arc(this.canvasSize[0]/2 - scaleRadius + dotSpacing*i, this.canvasSize[1]/2, 4, 0, Math.PI*2, true);
					ctx.strokeStyle = '#EEE';
					ctx.stroke();
				} else {
					ctx.beginPath();
					ctx.lineWidth = 2;
					ctx.arc(this.canvasSize[0]/2 - scaleRadius + dotSpacing*i, this.canvasSize[1]/2, 2, 0, Math.PI*2, true);
					ctx.strokeStyle = '#EEE';
					ctx.fillStyle = '#EEE';
					ctx.stroke();
					ctx.fill();
				}
			}

			// Draw black area for obs compass rose
			ctx.beginPath();
			ctx.lineWidth = (outerRadius-scaleRadius)*0.75;
			ctx.arc(this.canvasSize[0]/2, this.canvasSize[1]/2, outerRadius - (outerRadius - scaleRadius)/2, 0, Math.PI*2, true);
			ctx.strokeStyle = 'black';
			ctx.stroke();

			// Draw OBS compass rose label
			ctx.font = "13px Helvetica";
			ctx.textAlign = "center";
			ctx.fillStyle = 'white';

			ctx.translate(100, 100);
			ctx.rotate(-Math.PI*2*(this.obsSetting/360));
			ctx.translate(-100, -100);
			for (var i = 0; i <= 35.5; i = i + 0.5) {
				var tickMarkSize = 10;
				if (i % 1 != 0) tickMarkSize = 5;
				ctx.beginPath();
				ctx.lineWidth = 1;
				ctx.strokeStyle = 'white';
				ctx.moveTo(100, 33 - tickMarkSize);
				ctx.lineTo(100, 33);
				ctx.stroke();
				if (i % 3 == 0) {
					var label = i;
					if (i ==  0) label = 'N';
					if (i ==  9) label = 'E';
					if (i == 18) label = 'S';
					if (i == 27) label = 'W';
					ctx.fillText(label, 100, 26);
				}
				ctx.translate(100, 100);
				ctx.rotate(Math.PI*2*(5/360));
				ctx.translate(-100, -100); // undo translation
			}
			ctx.translate(100, 100);
			ctx.rotate(+Math.PI*2*(this.obsSetting/360));
			ctx.translate(-100, -100);

			ctx.fillStyle = 'white';
			//ctx.fillText(this.obsLabel(), scaleRadius*1.5, 27);

			// Draw OBS pointer triangle
			ctx.beginPath();
			ctx.lineWidth = 1;
			ctx.moveTo(100, 34);
			ctx.lineTo( 96, 44);
			ctx.lineTo(104, 44);
			ctx.lineTo(100, 34);
			ctx.strokeStyle = 'white';
			ctx.stroke();
			ctx.fillStyle = 'white';
			ctx.fill();

			// Draw ambiguity indicator
			var ambLabel;
			if (this.to_from == 'from')
				ambLabel = 'FROM'
			else if (this.to_from == 'to')
				ambLabel = 'TO';
			else
				ambLabel = "////";

			ctx.font = '11px Helvetica';
			ctx.textAlign = "center";
			ctx.fillStyle = '#EEEE99';
			if (ambLabel == "////") ctx.fillStyle = 'red';
			ctx.fillText(ambLabel, this.canvasSize[0] * 0.66, this.canvasSize[1] * 0.43);

			// Draw box around ambiguity indicator
/*			ctx.beginPath();
			ctx.lineWidth = 2;
			ctx.moveTo(this.canvasSize[0] * 0.66 - 20, this.canvasSize[1] * 0.43 + 3);
			ctx.lineTo(this.canvasSize[0] * 0.66 + 20, this.canvasSize[1] * 0.43 + 3);
			ctx.strokeStyle = 'white';
			ctx.stroke();
*/

			// Draw OBS knob
			ctx.beginPath();
			ctx.lineWidth = 2;
			ctx.arc(this.canvasSize[0]/2*0.333, this.canvasSize[1]/2*1.667, 15, 0, Math.PI*2, true);
			ctx.strokeStyle = 'white';
			ctx.stroke();
			ctx.fillStyle="black";
			ctx.fill();
			ctx.fillStyle = '#DDBB00';
			ctx.font = "10px Helvetica";
			ctx.textAlign = "center";
			ctx.fillText('OBS', this.canvasSize[0]/2*0.333 + 0, this.canvasSize[1]/2*1.667 + 3);
			this.obsKnobLocation = { x: this.canvasSize[0]/2*0.333, y: this.canvasSize[1]/2*1.667, r: 12 };
			console.log('OBS knob coordinates: ' + this.obsKnobLocation.x + ', ' + this.obsKnobLocation.y);

			/*
			 var context = ctx;
			 context.save();
			 context.translate(newx, newy);
			 context.rotate(-Math.PI/2);
			 context.textAlign = "center";
			 context.fillText("Your Label Here", labelXposition, 0);
			 context.restore();
			*/

  		},

		isMouseOnObsKnob: function(mousePos){
			if (mousePos.y <= this.obsKnobLocation.y - this.obsKnobLocation.r || mousePos.y >= this.obsKnobLocation.y + this.obsKnobLocation.r)
				return false;
			else if (mousePos.x > this.obsKnobLocation.x && mousePos.x < this.obsKnobLocation.x + this.obsKnobLocation.r)
				return 1; // right half
			else if (mousePos.x < this.obsKnobLocation.x && mousePos.x > this.obsKnobLocation.x - this.obsKnobLocation.r)
				return -1; // left half
		},

		update: function(){
			var stat = sim.calculateCdiDeflection(this, sim.airplane);
			this.cdiDisplacement = stat.cdiDeflect;
			if (stat.from == null)
				this.to_from = 'X';
			else if (stat.from == true)
				this.to_from = 'from';
			else if (stat.from == false)
				this.to_from = 'to';
			this.draw();
		},
	},

	calculateRadial: function(station, aircraft){
		var st_x = station.location[0];
		var st_y = station.location[1];
		var ac_x = aircraft.location[0];
		var ac_y = aircraft.location[1];

/*
		var lat1 = station.location[0];
		var lon1 = station.location[1];
		var lat2 = aircraft.location[0];
		var lon2 = aircraft.location[1];

		var tc1 = Math.atan2(Math.sin(lon1-lon2)*Math.cos(lat2), Math.cos(lat1)*Math.sin(lat2)-Math.sin(lat1)*Math.cos(lat2)*Math.cos(lon1-lon2)) % 2*Math.PI;
		return alert(tc1 * (180/Math.PI));
*/

		var dist_x = ac_x - st_x;
		var dist_y = ac_y - st_y;
		console.log('Aircraft position: ' + ac_x + ', ' + ac_y);
		console.log('Station  position: ' + st_x + ', ' + st_y);
		console.log('dist_x, dist_y: ' + dist_x + ', ' + dist_y);
		var atan = 0;
		if (dist_y != 0 && dist_x != 0) atan = Math.atan(dist_x / dist_y);
		atan = atan * (180/Math.PI);
		if (dist_x > 0 && dist_y < 0)
			atan = Math.abs(atan);
		else if (dist_x > 0 && dist_y > 0)
			atan = 90 - atan + 90;
		else if (dist_x < 0 && dist_y > 0)
			atan = 180 + Math.abs(atan);
		else if (dist_x < 0 && dist_y < 0)
			atan = 360 - atan;
		else if (dist_x < 0 && dist_y == 0)
			atan = 270;
		else if (dist_x > 0 && dist_y == 0)
			atan = 90;
		else if (dist_x == 0 && dist_y > 0)
			atan = 180;
		else if (dist_x == 0 && dist_y < 0)
			atan = 360;
		//end if
		console.log('The aircraft is on the ' + atan + ' degree radial.');
		return atan;
	},


	calculateCdiDeflection: function(station, aircraft){

		var actRad = circle(sim.calculateRadial(station, aircraft));
		var obsRad = circle(station.obsSetting);

		var diff   = -1 * (actRad - obsRad);

		if (diff < -180)
			diff = diff + 360;
		else if (diff > 180)
			diff = diff - 360;

		var diffRecip;
		if (diff < -90)
			diffRecip = diff + 180;
		else if (diff > 90)
			diffRecip = diff - 180;
		diffRecip = -1 * diffRecip;

		var sol;
		if (diff <= 90 && diff >= -90)
			sol = { offCourse: diff, cdiDeflect: diff/2, from: true };
		else if (diffRecip <= 90 && diffRecip >= -90)
			sol = { offCourse: diffRecip, cdiDeflect: diffRecip/2, from: false };
		else
			sol = { offCourse: null, cdiDeflect: null, from: null };

		if (sol.offCourse > 88 || sol.offCourse < -88) sol.from = null;

		return sol;
	},

	recipCourse: function(c){
		c = c + 180;
		if (c > 359) c = c - 360;
		return c;
	},
};

sim.vor1.location = [sim.overhead.canvasSize[0]/2, sim.overhead.canvasSize[1]/2];

sim.vor1.draw();
sim.vor1.update();

sim.overhead.draw();


sim.overhead.canvas.addEventListener('mousedown', function(event){
	var mousePos = sim.overhead.canvas.getMousePos(event);
	if (sim.overhead.isMouseOnAirplane(mousePos.x, mousePos.y)) {
		sim.airplane.isDragging = true;
		sim.airplane.dragOffset = 'not implemented';
		console.log('Begun dragging airplane!');
	}
}, false);

sim.overhead.canvas.addEventListener('mousemove', function(event){
	var mousePos = sim.overhead.canvas.getMousePos(event);
	if (sim.airplane.isDragging == true) {
		sim.airplane.location = [mousePos.x, mousePos.y];
		sim.overhead.draw();
		sim.vor1.update();
	} else {
		if (sim.overhead.isMouseOnAirplane(mousePos.x, mousePos.y)) {
			document.body.style.cursor = 'pointer';
		} else {
			document.body.style.cursor = 'auto';
		}
	}
}, false);

sim.overhead.canvas.addEventListener('mouseup', function(event){
	var mousePos = sim.overhead.canvas.getMousePos(event);
	if (sim.airplane.isDragging == true) {
		sim.airplane.isDragging = false;
		console.log('Finished dragging airplane!');
	}
}, false);

sim.vor1.canvas.addEventListener('mousemove', function(event){
	var mousePos = sim.vor1.canvas.getMousePos(event);
	var onKnob   = sim.vor1.isMouseOnObsKnob(mousePos);
	if (onKnob)
		document.body.style.cursor = 'pointer';
		//sim.vor1.canvas.cursor = 'pointer';
	else
		document.body.style.cursor = 'auto';
		//sim.vor1.canvas.cursor = 'auto';
	//end if	
}, false);

var isClickingObsKnob = false;
var isHoldingObsKnob  = false;
sim.vor1.canvas.addEventListener('mousedown', function(event){
	var mousePos = sim.vor1.canvas.getMousePos(event);
	var onKnob   = sim.vor1.isMouseOnObsKnob(mousePos);
	if (onKnob) {
		isClickingObsKnob = setTimeout(function(){
			isHoldingObsKnob = setInterval(function(){
				sim.vor1.obsSetting = sim.vor1.obsSetting + 2*onKnob;
				if (sim.vor1.obsSetting < 0)
					sim.vor1.obsSetting = 360 + sim.vor1.obsSetting;
				else if (sim.vor1.obsSetting > 359)
					sim.vor1.obsSetting = sim.vor1.obsSetting - 360;
				sim.vor1.draw();
				sim.vor1.update();
			}, 50);
		}, 400);
	}
}, false);

sim.vor1.canvas.addEventListener('mousemove', function(event){
	/* This case is if the user mouses down, then moves off the button */
	var mousePos = sim.vor1.canvas.getMousePos(event);
	if (isClickingObsKnob || isHoldingObsKnob) {
		var onKnob = sim.vor1.isMouseOnObsKnob(mousePos);
		if (!onKnob) {
			if (isClickingObsKnob) clearTimeout(isClickingObsKnob);
			if (isHoldingObsKnob) clearInterval(isHoldingObsKnob);
			isClickingObsKnob = false;
			isHoldingObsKnob  = false;
		}
	}
}, false);


sim.vor1.canvas.addEventListener('mouseup', function(event){
	if (isClickingObsKnob) clearTimeout(isClickingObsKnob);
	if (isHoldingObsKnob) clearInterval(isHoldingObsKnob);
	var mousePos = sim.vor1.canvas.getMousePos(event);
	var onKnob   = sim.vor1.isMouseOnObsKnob(mousePos);
	if (onKnob && !isHoldingObsKnob) {
		sim.vor1.obsSetting = sim.vor1.obsSetting + 1*onKnob;
		if (sim.vor1.obsSetting < 0)
			sim.vor1.obsSetting = 360 + sim.vor1.obsSetting;
		else if (sim.vor1.obsSetting > 359)
			sim.vor1.obsSetting = sim.vor1.obsSetting - 360;
		//end if
		sim.vor1.draw();
		sim.vor1.update();
	}
	isClickingObsKnob = false;
	isHoldingObsKnob  = false;
}, false);

/*
sim.vor1.canvas.addEventListener('click', function(event){
	var mousePos = sim.vor1.canvas.getMousePos(event);
	var onKnob   = sim.vor1.isMouseOnObsKnob(mousePos);
	if (onKnob) {
		sim.vor1.obsSetting = sim.vor1.obsSetting + onKnob;
		if (sim.vor1.obsSetting < 0)
			sim.vor1.obsSetting = 360 + sim.vor1.obsSetting;
		else if (sim.vor1.obsSetting > 359)
			sim.vor1.obsSetting = sim.vor1.obsSetting - 360;
		//end if
		sim.vor1.draw();
		sim.vor1.update();
	}
}, false);
*/

document.getElementById('input-heading').value = 360;
sim.airplane.heading = 360;

alert("Welcome to the VOR simulator!\n\nClick and drag the miniature airplane in the overhead view to move it. You can also adjust its heading by entering a new heading in the box below the overhead view or using the plus/minus buttons.\n\nClick the right half of the OBS knob on the VOR indicator to increase the OBS selection; click the left half to decrease it. Hold the mouse button down to spin it faster!\n\nHave fun.");

</script>
